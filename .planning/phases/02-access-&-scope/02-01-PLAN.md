---
phase: 02-access-&-scope
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/config/paths.ts
  - src/config/notion-auth.ts
  - src/state/workspace-root.ts
autonomous: true

must_haves:
  truths:
    - "Token config can be saved and loaded from an OS-specific config path."
    - "Workspace root selection persists locally with schema validation."
    - "Malformed config data is rejected before use."
  artifacts:
    - path: "src/config/paths.ts"
      provides: "Resolved config directory and file paths"
    - path: "src/config/notion-auth.ts"
      provides: "Notion token schema and load/save helpers"
    - path: "src/state/workspace-root.ts"
      provides: "Workspace root schema and load/save helpers"
    - path: "package.json"
      provides: "Notion SDK and atomic write dependencies"
  key_links:
    - from: "src/config/notion-auth.ts"
      to: "env-paths"
      via: "config path resolver"
      pattern: "envPaths"
    - from: "src/config/notion-auth.ts"
      to: "write-file-atomic"
      via: "atomic write"
      pattern: "writeFileAtomic"
---

<objective>
Create persisted config and state storage for Notion access and workspace root selection.

Purpose: Provide validated local storage for the token and selected root before wiring the access flow.
Output: Config/state helpers and updated dependencies for safe persistence.
</objective>

<execution_context>
@C:\Users\Referent BIM\.config\opencode/get-shit-done/workflows/execute-plan.md
@C:\Users\Referent BIM\.config\opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-access-&-scope/02-CONTEXT.md
@.planning/phases/02-access-&-scope/02-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add config pathing + Notion token storage</name>
  <files>src/config/paths.ts, src/config/notion-auth.ts</files>
  <action>
Create config helpers that persist the Notion integration token using OS-specific paths.
- Use env-paths to define a base config directory (app name: gsd-notion-workspace) and ensure the directory exists.
- In src/config/paths.ts, export helpers to return absolute paths for auth config and root state files.
- In src/config/notion-auth.ts, define a zod schema for the token payload, plus load/save helpers that:
  - Return null when the config file is missing.
  - Validate JSON content with zod before returning it.
  - Persist the token with write-file-atomic (no manual temp files).
  - Never log or stringify the token in error messages.
Keep the file format as JSON with a minimal shape (token + updated_at ISO string).
  </action>
  <verify>Confirm src/config/notion-auth.ts exports load/save helpers and uses zod + write-file-atomic.</verify>
  <done>Token config can be safely loaded, validated, and saved without leaking the token.</done>
</task>

<task type="auto">
  <name>Task 2: Add workspace root state storage</name>
  <files>src/state/workspace-root.ts</files>
  <action>
Create a persisted workspace-root state module.
- Define a zod schema covering both root types: page and database.
- For database roots, require database_id and data_source_id; for page roots, require page_id.
- Store optional metadata such as title and url for user feedback.
- Export load/save helpers that share the config directory path from src/config/paths.ts.
- Validate JSON on load and return null if the file is missing or invalid.
  </action>
  <verify>Confirm src/state/workspace-root.ts exports schema, types, and load/save helpers.</verify>
  <done>Workspace root selection can be persisted and validated on load.</done>
</task>

<task type="auto">
  <name>Task 3: Add Notion SDK + atomic write dependencies</name>
  <files>package.json, package-lock.json</files>
  <action>
Install dependencies required for access setup and persistence.
- Add @notionhq/client and write-file-atomic to dependencies.
- Run npm install to update package-lock.json.
  </action>
  <verify>package.json lists @notionhq/client and write-file-atomic; package-lock.json updated.</verify>
  <done>Dependencies for Notion API access and atomic writes are installed.</done>
</task>

</tasks>

<verification>
- npm run build
- Confirm auth config + root state files serialize to JSON under the OS config directory.
</verification>

<success_criteria>
- Token config and workspace root state persist locally with zod validation.
- Dependencies for Notion access and atomic writes are installed and build passes.
</success_criteria>

<output>
After completion, create `.planning/phases/02-access-&-scope/02-01-SUMMARY.md`
</output>
