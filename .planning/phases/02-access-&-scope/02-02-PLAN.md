---
phase: 02-access-&-scope
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/notion/client.ts
  - src/notion/ids.ts
  - src/notion/root.ts
  - src/notion/verify.ts
autonomous: true

must_haves:
  truths:
    - "A Notion URL or ID resolves to a page or database with title metadata."
    - "Capability checks validate token, read access, and write/archiving permissions."
    - "Database roots expose data source IDs needed for later page creation."
  artifacts:
    - path: "src/notion/client.ts"
      provides: "Notion SDK client factory"
    - path: "src/notion/ids.ts"
      provides: "Notion ID parsing and normalization"
    - path: "src/notion/root.ts"
      provides: "Root resolver for page or database"
    - path: "src/notion/verify.ts"
      provides: "Token and capability probe helpers"
  key_links:
    - from: "src/notion/client.ts"
      to: "@notionhq/client"
      via: "Client({ auth })"
      pattern: "new Client"
    - from: "src/notion/verify.ts"
      to: "Notion pages.create"
      via: "access probe"
      pattern: "pages\.create"
---

<objective>
Implement Notion API access verification and root resolution helpers.

Purpose: Provide reusable, testable Notion access checks before wiring the CLI flow.
Output: Notion client, ID parsing, root resolution, and capability probe utilities.
</objective>

<execution_context>
@C:\Users\Referent BIM\.config\opencode/get-shit-done/workflows/execute-plan.md
@C:\Users\Referent BIM\.config\opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-access-&-scope/02-CONTEXT.md
@.planning/phases/02-access-&-scope/02-RESEARCH.md
@src/workflow/init.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Notion client factory + ID parsing</name>
  <files>src/notion/client.ts, src/notion/ids.ts</files>
  <action>
Create core Notion helpers.
- In src/notion/client.ts, export a createNotionClient(token) function that instantiates @notionhq/client.
- In src/notion/ids.ts, implement helpers to:
  - Extract the 32-character hex ID from a Notion URL or raw ID.
  - Normalize IDs to dashed format for API calls.
  - Return a clear error when no valid ID is found.
Keep helpers pure and free of IO or logging.
  </action>
  <verify>Confirm src/notion/ids.ts exports a parse/normalize function and throws on invalid input.</verify>
  <done>Notion client creation and ID normalization are available for reuse.</done>
</task>

<task type="auto">
  <name>Task 2: Resolve root page or database metadata</name>
  <files>src/notion/root.ts</files>
  <action>
Implement root resolution from a user-provided URL/ID.
- Accept an already-created Notion client plus the raw input string.
- Parse/normalize the ID, then attempt page retrieval; if not found, attempt database retrieval.
- Return a ResolvedRoot union that includes:
  - kind: "page" | "database"
  - page_id or database_id
  - title (fall back to "Untitled")
  - url if available
  - data_source_ids (for database roots)
- If database has zero data sources, return an explicit error explaining the requirement.
Do not prompt here; only return data for the caller to decide.
  </action>
  <verify>Confirm resolveRoot returns the correct union shape for page vs database inputs.</verify>
  <done>Root selection can be resolved to a page or database with metadata.</done>
</task>

<task type="auto">
  <name>Task 3: Add capability probe helpers</name>
  <files>src/notion/verify.ts</files>
  <action>
Create verification helpers that confirm token and capability access.
- verifyToken: call users.me and return basic metadata.
- verifyWorkspaceAccess: perform a lightweight search (page_size: 1) to confirm workspace-wide access is not restricted to the selected root.
- verifyRootCapabilities: attempt read + write probes:
  - Read: use the resolved root to ensure retrieve succeeds.
  - Write: create a test page under the selected parent (page_id or data_source_id), then archive it immediately.
- Return a structured result with per-check status and a summary suitable for CLI display.
- Map common Notion errors (restricted_resource, object_not_found) into user-facing messages that mention sharing the integration.
Keep the test page label obvious (e.g., "NWS Access Check") and include a timestamp suffix to avoid collisions.
  </action>
  <verify>Confirm verify helpers return structured check results without throwing on known Notion errors.</verify>
  <done>Capability probes can validate token, scope, and write access before proceeding.</done>
</task>

</tasks>

<verification>
- npm run build
- Confirm capability helpers call users.me, pages.create, and pages.update as part of probes.
</verification>

<success_criteria>
- Root resolution correctly distinguishes page vs database and surfaces data source IDs.
- Capability probe helpers provide actionable results for the init workflow.
</success_criteria>

<output>
After completion, create `.planning/phases/02-access-&-scope/02-02-SUMMARY.md`
</output>
