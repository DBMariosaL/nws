---
phase: 02-access-&-scope
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/cli/commands/init.ts
  - src/cli/prompts/access.ts
  - src/utils/mask.ts
  - src/workflow/init.ts
autonomous: true
user_setup:
  - service: notion
    why: "Access token required to verify workspace scope"
    env_vars: []
    dashboard_config:
      - task: "Create a Notion integration and copy its secret token"
        location: "Notion workspace settings -> Integrations"
      - task: "Share the target root page or database with the integration"
        location: "Notion page/database -> Share -> Invite integration"

must_haves:
  truths:
    - "User can enter a token and see a masked confirmation."
    - "Init blocks progress when access verification fails."
    - "Selected root is persisted and summarized after success."
  artifacts:
    - path: "src/cli/prompts/access.ts"
      provides: "Interactive token + root prompts"
    - path: "src/workflow/init.ts"
      provides: "Access and scope init workflow"
    - path: "src/utils/mask.ts"
      provides: "Token masking helper"
    - path: "src/cli/commands/init.ts"
      provides: "CLI init command wired to workflow"
  key_links:
    - from: "src/workflow/init.ts"
      to: "src/config/notion-auth.ts"
      via: "load/save config"
      pattern: "loadNotionAuth|saveNotionAuth"
    - from: "src/workflow/init.ts"
      to: "src/notion/verify.ts"
      via: "capability checks"
      pattern: "verify"
---

<objective>
Wire the interactive access + scope flow into the init command.

Purpose: Let users provide a token, select a root, and receive verified capabilities feedback.
Output: Prompt-driven init workflow that persists access config and root selection.
</objective>

<execution_context>
@C:\Users\Referent BIM\.config\opencode/get-shit-done/workflows/execute-plan.md
@C:\Users\Referent BIM\.config\opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-access-&-scope/02-CONTEXT.md
@.planning/phases/02-access-&-scope/02-RESEARCH.md
@src/cli/commands/init.ts
@src/workflow/init.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build interactive access + scope prompts</name>
  <files>src/cli/prompts/access.ts, src/utils/mask.ts, src/workflow/init.ts</files>
  <action>
Implement the init workflow that gathers token + root selection and runs verification.
- Create src/utils/mask.ts with a helper that shows only the last 4 characters of a token.
- Create src/cli/prompts/access.ts to:
  - Prompt for a token (masked input).
  - Reuse a saved token when available; if --yes is set, reuse without asking.
  - Prompt for a Notion URL/ID for the workspace root.
  - If a database root has multiple data sources, prompt for selection; if --yes, select the first.
- Update src/workflow/init.ts to orchestrate:
  1) Load existing token/root from config/state.
  2) Prompt for token if missing or user declines reuse.
  3) Immediately call verifyToken and fail fast with actionable messaging on error.
  4) Resolve root input and run capability probes (read + write + archive).
  5) On success, persist token + root and print a capabilities summary including masked token.
  6) On failure, return a WorkflowResult error without persisting changes.
Use a checklist-style success summary and keep error messages concise but actionable (mention sharing the integration and required capabilities).
  </action>
  <verify>Run `nws init` and confirm it prompts for token and root, then blocks on failed verification.</verify>
  <done>Init workflow collects token/root, verifies access, and persists results on success.</done>
</task>

<task type="auto">
  <name>Task 2: Respect JSON output in the init command</name>
  <files>src/cli/commands/init.ts</files>
  <action>
Wire init command output through the shared logger.
- Replace direct console.log/error calls with logResult from src/utils/logging.ts.
- Keep exit codes identical to the current behavior.
- Ensure the --json flag produces JSON output for both success and error cases.
  </action>
  <verify>Run `nws init --json` and confirm it prints JSON with status and message.</verify>
  <done>Init command outputs consistent JSON when requested.</done>
</task>

</tasks>

<verification>
- npm run build
- `nws init` prompts for token + root, and fails when access is restricted.
</verification>

<success_criteria>
- Token setup, root selection, and capability verification run in init without manual edits.
- Access failures stop progress and provide guidance to fix sharing/capabilities.
</success_criteria>

<output>
After completion, create `.planning/phases/02-access-&-scope/02-03-SUMMARY.md`
</output>
