---
phase: 01-cli-&-workflow-shell
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - src/cli/index.ts
  - src/cli/commands/init.ts
  - src/cli/commands/plan.ts
  - src/cli/commands/apply.ts
  - src/cli/commands/handover.ts
  - src/workflow/init.ts
  - src/workflow/plan.ts
  - src/workflow/apply.ts
  - src/workflow/handover.ts
  - src/utils/logging.ts
autonomous: true

must_haves:
  truths:
    - "User can run `nws init`, `nws plan`, `nws apply`, and `nws handover` successfully."
    - "CLI runs in non-interactive/headless mode when `--yes` is provided."
    - "CLI exposes a single `nws` binary via npm bin mapping."
  artifacts:
    - path: "package.json"
      provides: "npm bin entry for `nws` and scripts"
      contains: "\"bin\": { \"nws\""
    - path: "src/cli/index.ts"
      provides: "CLI entrypoint wiring to subcommands"
    - path: "src/workflow/init.ts"
      provides: "init workflow stub"
    - path: "src/workflow/plan.ts"
      provides: "plan workflow stub"
    - path: "src/workflow/apply.ts"
      provides: "apply workflow stub"
    - path: "src/workflow/handover.ts"
      provides: "handover workflow stub"
  key_links:
    - from: "package.json"
      to: "bin/cli.js"
      via: "bin mapping"
      pattern: "\"nws\"\\s*:\\s*\"bin/cli.js\""
    - from: "src/cli/commands/apply.ts"
      to: "src/workflow/apply.ts"
      via: "command handler call"
      pattern: "applyWorkflow\\("
---

<objective>
Establish the Node.js/TypeScript CLI shell with runnable workflow commands and headless-safe behavior.

Purpose: Provide a single `nws` binary that can run the workflow commands and support automation.
Output: CLI scaffolding, command wiring, and workflow stubs that execute without prompts when `--yes` is set.
</objective>

<execution_context>
@C:\Users\Referent BIM\.config\opencode/get-shit-done/workflows/execute-plan.md
@C:\Users\Referent BIM\.config\opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-cli-&-workflow-shell/01-RESEARCH.md
@.planning/research/STACK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold the Node/TypeScript CLI package</name>
  <files>package.json, tsconfig.json</files>
  <action>
Create a minimal Node.js + TypeScript package for the CLI using ESM. Add `bin` mapping for `nws` to `bin/cli.js`, set `type: "module"`, and require Node 24+ in `engines`. Include scripts: `build` (tsc), `dev` (tsx), `start` (node bin/cli.js). Add dependencies: `commander`, `prompts`, `env-paths`, `zod`, `pino`. Add dev deps: `typescript`, `tsx`.

Create `tsconfig.json` with `module`/`moduleResolution` set to `NodeNext`, `rootDir` = `src`, `outDir` = `bin`, `target` = `ES2022`, `strict: true`, and `skipLibCheck: true`. Ensure build output preserves the shebang from the CLI entry file.
  </action>
  <verify>npm install && npm run build</verify>
  <done>`bin/cli.js` is generated and `package.json` exposes `nws` via the npm bin mapping.</done>
</task>

<task type="auto">
  <name>Task 2: Wire CLI commands to workflow stubs (CLI-02)</name>
  <files>src/cli/index.ts, src/cli/commands/init.ts, src/cli/commands/plan.ts, src/cli/commands/apply.ts, src/cli/commands/handover.ts, src/workflow/init.ts, src/workflow/plan.ts, src/workflow/apply.ts, src/workflow/handover.ts</files>
  <action>
Create `src/cli/index.ts` with a `#!/usr/bin/env node` shebang, set up commander root command `nws`, and register subcommands `init`, `plan`, `apply`, `handover`. Add minimal workflow stubs in `src/workflow/*.ts` that return a structured result `{ command, status, message }` without side effects.

Implement each command handler in `src/cli/commands/*.ts` to call its workflow stub and exit with a non-zero code on errors. Ensure `nws init|plan|apply|handover` runs end-to-end and the command handlers pass through options to the workflow layer.
  </action>
  <verify>npm run build && node "bin/cli.js" init --yes && node "bin/cli.js" plan --yes</verify>
  <done>`nws init/plan/apply/handover` execute their workflow stubs without crashing.</done>
</task>

<task type="auto">
  <name>Task 3: Implement headless and confirmation behavior (CLI-03)</name>
  <files>src/cli/index.ts, src/cli/commands/apply.ts, src/utils/logging.ts</files>
  <action>
Add global options `--yes` and `--json` at the CLI root and propagate them to the command handlers. Implement a small logger helper in `src/utils/logging.ts`: when `--json` is true, emit a single-line JSON payload (use `pino` or `console.log(JSON.stringify(...))`), otherwise print a short human-readable line.

For `apply`, require explicit confirmation via `prompts` unless `--yes` is set. If `process.stdout.isTTY` is false and `--yes` is not provided, exit with a clear error instructing to pass `--yes`. Ensure `--yes` bypasses all prompts and is safe for headless automation.
  </action>
  <verify>npm run build && node "bin/cli.js" apply --yes --json</verify>
  <done>`--yes` runs without prompts and `--json` emits a single JSON object in headless mode.</done>
</task>

</tasks>

<verification>
- `nws --help` lists init/plan/apply/handover commands.
- Running `node "bin/cli.js" init --yes` exits 0 and prints a completion message.
- `node "bin/cli.js" apply --yes --json` outputs a single JSON object and exits 0.
</verification>

<success_criteria>
The CLI can be built and executed via the `nws` binary, and the core workflow commands run in headless mode when `--yes` is supplied.
</success_criteria>

<output>
After completion, create `.planning/phases/01-cli-&-workflow-shell/01-01-SUMMARY.md`
</output>
